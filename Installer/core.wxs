<?xml version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Fragment Id='CoreFragment'>

    <!-- Top level junk - readme, changelog, etc -->
    <DirectoryRef Id='INSTALLDIR'>
      <Component Id="BaseFiles" Guid="2448b1b1-f2ec-4153-96c6-bcaae7692ef9" DiskId="1">
        <File Id="ChangeLog" Name="CHANGES" Source="..\CHANGES" />
        <File Id="RelNotes" Name="Release Notes.txt" Source="..\Release Notes.txt" />
        <?if $(var.IsGPL) = 1 ?>
        <File Id="COPYING" Name="COPYING" Source="..\COPYING" DiskId="1" />
        <File Id="README1" Name="README" Source="..\README" DiskId="1"/>
	<?else?>
        <File Id="README2" Name="README" Source="..\README-Commercial" DiskId="1"/>
        <?endif?>
        <RegistryKey Id="MySqlKey" Root="HKLM" Action="createAndRemoveOnUninstall"
                     Key="Software\MySQL AB\MySQL Connector/Net">
          <RegistryValue Id="Location" Name="Location" Value="[INSTALLDIR]" Type="string"/>
          <RegistryValue Id="Version" Name="Version" Value="$(var.Version)" Type="string"/>
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- .Net 2.0 Binaries -->
    <DirectoryRef Id='assemblies_v2'>
      <Component Id="Net20" Guid="0e8af006-273c-49bb-b7c1-ec1737260a5a">
        <File Id="MySqlData" Name="MySql.Data.dll"
              Source="..\mysql.data\provider\bin\release\mysql.data.dll" DiskId="1"/>

        <util:PerformanceCategory Id="PMDataCategoryId" Name=".NET Data Provider for MySQL"
                                  MultiInstance="no" Help="This category includes a series of counters for MySQL.">
          <util:PerformanceCounter Name="HardProcedureQueries" Type="numberOfItems32" Help="The number of times a procedures metadata had to be queried from the server." />
          <util:PerformanceCounter Name="SoftProcedureQueries" Type="rateOfCountsPerSecond32" Help="The number of times a procedures metadata was retrieved from the client-side cache." />
        </util:PerformanceCategory>

        <RemoveFile Id="RemoveStateFile" Name="*.InstallState" On="uninstall"/>

      </Component>
      <Directory Id="MySql.Data.DummyDir" Name="GAC">
        <Component Id="GAC20" Guid="58f70e4a-96f7-4b67-bdab-9b77a60f9c09">
          <File Id="MySql.Data.GAC" Name="MySql.Data.dll"
                Source="..\mysql.data\provider\bin\release\mysql.data.dll" DiskId="1" Assembly=".net" KeyPath="yes"/>
        </Component>
      </Directory>
    </DirectoryRef>

    <!-- Start menu junk -->
    <DirectoryRef Id='ShortCutDir'>
      <Component Id="StartMenuComponent" Guid="31e1c7c6-e06d-4214-82ca-58e67e5232e2">
        <CreateFolder/>
        <!-- Clear ICE18 error -->
        <Shortcut Id="S100" Name="Documentation" Description="Complete documentation for the connector"
					Target="[DocsDir]/MySql.Data.chm" Directory="ShortCutDir" />
        <Shortcut Id="S101" Name="ChangeLog" Description="Complete changelog for the connector"
                  Directory="ShortCutDir" Icon="ChangeLogIcon" Target="[INSTALLDIR]/CHANGES"/>
        <Shortcut Id="S102" Name="Release Notes" Description="Release notes"
                  Directory="ShortCutDir" Target="[INSTALLDIR]/Release Notes.txt"/>
      </Component>
    </DirectoryRef>

    <Feature Id="Core.Feature" Level="1" Title="Core Components" Description="Core Components"
             ConfigurableDirectory ="INSTALLDIR" Absent="disallow" Display="2">
      <ComponentRef Id="BaseFiles"/>
      <ComponentRef Id="Net20"/>
      <ComponentRef Id="GAC20"/>
      <ComponentRef Id="StartMenuComponent"/>
    </Feature>

    <!-- Entity framework 2.0 feature -->
    <DirectoryRef Id='assemblies_v2'>
      <Component Id="EF.v2" Guid="AB734C75-F5DC-491e-A2BC-52D5061881B7" DiskId="1">
        <Condition>NETFRAMEWORK20</Condition>
        <File Id="MySql.Data.EF" Name="MySql.Data.Entity.dll"
              Source="..\mysql.data.entity\provider\bin\release\mysql.data.entity.dll" DiskId="1"/>
      </Component>
      <Component Id="EF.v2.GAC" Guid="12218CCC-B085-46af-AA5F-FB9306FE621E" DiskId="1">
        <Condition>NETFRAMEWORK20</Condition>
        <File Id="MySql.Data.EF.GAC" Name="MySql.Data.Entity.dll"
              Source="..\mysql.data.entity\provider\bin\release\mysql.data.entity.dll" DiskId="1"
              Assembly=".net" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Entity framework 4.0 feature -->
    <DirectoryRef Id='assemblies_v4'>
      <Component Id="EF.v4" Guid="E6B683F6-727A-43c9-B955-6BEE94EF61C7" DiskId="1">
        <Condition>NETFRAMEWORK40FULL</Condition>
        <File Id="MySql.Data.EF.v4" Name="MySql.Data.Entity.dll"
              Source="..\mysql.data.entity\provider\bin\release-4.0\mysql.data.entity.dll" DiskId="1"/>
      </Component>
      <Component Id="EF.v4.GAC" Guid="A9C03468-5A59-443f-85DC-C0149EBB55C8" DiskId="1">
        <Condition>NETFRAMEWORK40FULL</Condition>
        <File Id="MySql.Data.EF.v4.GAC" Name="MySql.Data.Entity.dll"
              Source="..\mysql.data.entity\provider\bin\release-4.0\mysql.data.entity.dll" DiskId="1"
              Assembly=".net" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="Entity.T4.DBGenDir">
      <Component Id="EF.T4" Guid="6555D339-120C-4D62-B60C-08764D8CA739">
        <Condition>VS_2010_PATH</Condition>
        <File Id="SSDLToMySQL" Name="SSDLToMySQL.tt" DiskId="1"
              Source="..\MySql.Data.Entity\T4Templates\SSDLToMySQL.tt"/>
        <File Id="GenerateMySQL.Utility" Name="GenerateMySQL.Utility.ttinclude" DiskId="1"
              Source="..\MySql.Data.Entity\T4Templates\GenerateMySQL.Utility.ttinclude"/>
      </Component>
    </DirectoryRef>    
    
    <Feature Id="EntityFramework" Level="1" Title="Entity Framework Support"
             Description="Support for the entity framework">
      <Condition Level='0'>Not NETFRAMEWORK20 AND Not NETFRAMEWORK40FULL</Condition>
      <ComponentRef Id="EF.v2"/>
      <ComponentRef Id="EF.v2.GAC"/>
      <ComponentRef Id="EF.v4"/>
      <ComponentRef Id="EF.v4.GAC"/>
      <ComponentRef Id="EF.T4"/>
    </Feature>

    <InstallExecuteSequence>
      <Custom Action="SetFWVersion_v2" After="CostFinalize">NETFRAMEWORK20</Custom>
      <Custom Action="SetFWVersion_v4" After="SetFWVersion_v2">NETFRAMEWORK40FULL</Custom>
      <Custom Action='ManagedDataInstallSetup' After="InstallFiles">NOT Installed</Custom>
      <Custom Action='ManagedDataInstall' After="ManagedDataInstallSetup">NOT Installed</Custom>
      <Custom Action='ManagedDataUnInstallSetup' Before="RemoveFiles">Installed</Custom>
      <Custom Action='ManagedDataUnInstall' After="ManagedDataUnInstallSetup">Installed</Custom>
    </InstallExecuteSequence>

    <CustomAction Id="SetFWVersion_v2" Property="FrameworkVersion" Value="v2.0.50727"/>
    <CustomAction Id="SetFWVersion_v4" Property="FrameworkVersion" Value="v4.0.30319"/>
    <CustomAction Id="ManagedDataInstallSetup" Property="ManagedDataInstall"
                  Value='"[WindowsFolder]\Microsoft.NET\Framework\[FrameworkVersion]\installUtil.exe" /LogToConsole=false /LogFile=  "[#MySqlData]"'/>
    <CustomAction Id='ManagedDataUnInstallSetup' Property="ManagedDataUnInstall"
                  Value='"[WindowsFolder]\Microsoft.NET\Framework\[FrameworkVersion]\installUtil.exe" /LogToConsole=false /LogFile= /u "[#MySqlData]"'/>
    <CustomAction Id="ManagedDataInstall" BinaryKey="WixCA" DllEntry="CAQuietExec" Return="check" Execute='deferred' Impersonate='no'/>
    <CustomAction Id="ManagedDataUnInstall" BinaryKey="WixCA" DllEntry="CAQuietExec" Return="check" Execute='deferred' Impersonate='no'/>
  </Fragment>
</Wix>


